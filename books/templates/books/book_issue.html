{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–í—ã–¥–∞—á–∞ –∫–Ω–∏–≥</title>
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        .modal {
            display: none;
            position: fixed;
            z-index: 1001;
            top: 0; left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 10px;
            width: 400px;
            max-width: 90%;
        }
        .close-modal {
            float: right;
            font-size: 20px;
            cursor: pointer;
            color: red;
        }
        .book-issue-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            margin-top: 20px;
            text-align: left;
            vertical-align: top;
        }
        .book-issue-table th, td {
            padding: 10px;
            border: 1px solid #ccc;
        }
        .book-issue-table th {
            background: #f0f0f0;
        }
        .book-issue-table th:first-child,
        .book-issue-table td:first-child {
            width: 50px;
            text-align: center;
        }
        #search-reader {
            margin-top: 20px;
            margin-bottom: 20px;
            width: 100%;
            max-width: 400px;
            padding: 10px;
            font-size: 16px;
        }
        .delete-button {
            background-color: #4CAF50;
            color: white;
            padding: 5px 10px;
            font-size: 14px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .delete-button:hover {
            background-color: #388e3c;
        }
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .dropdown-btn {
            cursor: pointer;
            background-color: #e0e0e0;
            border: 1px solid #ccc;
            padding: 4px 8px;
            font-weight: bold;
            border-radius: 4px;
        }
        .dropdown-list {
            display: none;
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #aaa;
            margin: 5px 0;
            padding: 5px;
            background: #fff;
        }
        .dropdown-list div {
            padding: 4px;
            cursor: pointer;
        }
        .dropdown-list div:hover {
            background-color: #eee;
        }

        .table-header-inline {
            display: flex;
            align-items: baseline;
            gap: 10px;
            margin-top: 20px;
        }
        
        .overdue-inline-link {
            font-size: 24px; /* —Ç–∞–∫–æ–π –∂–µ, –∫–∞–∫ —É h2 */
            font-weight: bold;
            color: #100000;
            text-decoration: none; /* —É–±—Ä–∞—Ç—å –ø–æ–¥—á—ë—Ä–∫–∏–≤–∞–Ω–∏–µ */
        }
        
        .overdue-inline-link:hover {
            text-decoration: none;
            opacity: 0.8; /* –Ω–µ–±–æ–ª—å—à–æ–π —ç—Ñ—Ñ–µ–∫—Ç –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
        }

    </style>
</head>
<body>

<div class="header-bar">
    <div class="header-nav">
        <a href="{% url 'book_list' %}" class="header-title">–£–ü–†–ê–í–õ–ï–ù–ò–ï –ö–ù–ò–ñ–ù–´–ú –§–û–ù–î–û–ú</a>
        <a href="{% url 'book_issue' %}" class="header-link">–í–´–î–ê–ß–ê –ö–ù–ò–ì</a>
        <a href="{% url 'readers_list' %}" class="header-link">–ß–ò–¢–ê–¢–ï–õ–ò</a>
        <a href="{% url 'statistics' %}" class="header-link">–°–¢–ê–¢–ò–°–¢–ò–ö–ê</a>
        <a href="{% url 'staff_login' %}" class="header-link">–í–´–•–û–î</a>
    </div>
</div>

<div class="content">

    <div class="table-header-inline">
        <h2 id="table-title">–¢–∞–±–ª–∏—Ü–∞ –≤—ã–¥–∞–Ω–Ω—ã—Ö –∫–Ω–∏–≥</h2>
        <a href="#" class="overdue-inline-link" id="toggle-overdue">–¢–∞–±–ª–∏—Ü–∞ –¥–æ–ª–∂–Ω–∏–∫–æ–≤</a>
    </div>

    <div class="top-bar" id="main-controls">
        <input type="text" id="search-reader" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –∏ —Ñ–∞–º–∏–ª–∏–∏...">
        <button id="openIssueModal" class="add-button">‚ûï –í—ã–¥–∞—Ç—å –∫–Ω–∏–≥—É</button>
    </div>

    <!-- –¢–∞–±–ª–∏—Ü–∞ —Å –≤—ã–¥–∞–Ω–Ω—ã–º–∏ –∫–Ω–∏–≥–∞–º–∏ -->
    <div id="issue-section">
        <table class="book-issue-table">
            <thead>
            <tr>
                <th>‚Ññ</th>
                <th>–õ–æ–≥–∏–Ω Telegram</th>
                <th>–ò–º—è –∏ —Ñ–∞–º–∏–ª–∏—è</th>
                <th>–ö–Ω–∏–≥–∞</th>
                <th>–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th>
                <th>–î–∞—Ç–∞ –≤—ã–¥–∞—á–∏</th>
                <th>–î–∞—Ç–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞</th>
                <th>–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ –∫–Ω–∏–≥–∏</th>
            </tr>
            </thead>
            <tbody id="issue-body">
            {% for issue in issues %}
                <tr>
                    <td>{{ forloop.counter }}</td>
                    <td>{{ issue.reader.telegram_username }}</td>
                    <td>{{ issue.reader.full_name }}</td>
                    <td>{{ issue.book.title }}</td>
                    <td>{{ issue.issued_by }}</td>
                    <td>{{ issue.issue_date }}</td>
                    <td>{{ issue.return_date }}</td>
                    <td>
                        <form method="post" action="{% url 'delete_issue' issue.pk %}" style="margin:0">
                            {% csrf_token %}
                            <button type="submit" class="delete-button">–î–∞</button>
                        </form>
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- –¢–∞–±–ª–∏—Ü–∞ —Å –¥–æ–ª–∂–Ω–∏–∫–∞–º–∏ -->
    <div id="overdue-section" style="display: none;"></div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
<div id="issueModal" class="modal">
    <div class="modal-content">
        <span id="closeIssueModal" class="close-modal">&times;</span>
        <h3>–í—ã–¥–∞—Ç—å –∫–Ω–∏–≥—É</h3>
        <form method="post" action="{% url 'add_book_issue' %}">
            {% csrf_token %}
            <div>
                <input type="text" name="full_name" id="nameField" placeholder="–ò–º—è –∏ —Ñ–∞–º–∏–ª–∏—è" required
                       style="width: 350px; padding: 10px; margin-bottom: 10px;">
                <span class="dropdown-btn" onclick="toggleDropdown('nameDropdown')">‚Ä∫</span>
                <div class="dropdown-list" id="nameDropdown">
                    {% for reader in readers %}
                        <div onclick="selectReader('{{ reader.full_name }}', '{{ reader.telegram_username|default_if_none:"" }}')"
                             data-fullname="{{ reader.full_name }}"
                             data-telegram="{{ reader.telegram_username|default_if_none:"" }}">
                            {{ reader.full_name }}{% if not reader.telegram_username %} (–±–µ–∑ Telegram){% else %} ({{ reader.telegram_username }}){% endif %}
                        </div>
                    {% endfor %}
                </div>
            </div>

            <div>
                <input type="text" name="telegram_username" id="telegramField" placeholder="–õ–æ–≥–∏–Ω Telegram (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"
                       style="width: 350px; padding: 10px; margin-bottom: 10px;">
                <span class="dropdown-btn" onclick="toggleDropdown('telegramDropdown')">‚Ä∫</span>
                <div class="dropdown-list" id="telegramDropdown">
                    {% for reader in readers %}
                        <div onclick="selectValue('telegramField', '{{ reader.telegram_username }}')">
                            {{ reader.telegram_username }}
                        </div>
                    {% endfor %}
                </div>
            </div>

            <div>
                <input type="text" name="book_title" id="bookField" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–Ω–∏–≥–∏" required
                       style="width: 350px; padding: 10px; margin-bottom: 10px;">
                <span class="dropdown-btn" onclick="toggleDropdown('bookDropdown')">‚Ä∫</span>
                <div class="dropdown-list" id="bookDropdown">
                    {% for book in books %}
                        <div onclick="selectValue('bookField', '{{ book.title }}')">{{ book.title }}</div>
                    {% endfor %}
                </div>
            </div>

            <input type="text" name="issued_by" placeholder="–°–æ—Ç—Ä—É–¥–Ω–∏–∫ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"
                   style="width: 350px; padding: 10px; margin-bottom: 10px;">
            <button type="submit" style="padding: 10px 20px;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </form>
    </div>
</div>


<footer class="site-footer">
    <div class="footer-content">
        <p>Made by Andrey Kovalev, Vladivostok, Russia</p>
        <a href="https://t.me/zxcikona20" target="_blank" title="Telegram">
            <img src="{% static 'images/telegram_icon.png' %}" alt="Telegram" class="telegram-icon">
        </a>
    </div>
</footer>
<script>
    const modal = document.getElementById('issueModal');
    const openBtn = document.getElementById('openIssueModal');
    const closeBtn = document.getElementById('closeIssueModal');

    openBtn.onclick = () => modal.style.display = 'flex';
    closeBtn.onclick = () => modal.style.display = 'none';
    window.onclick = (e) => { if (e.target === modal) modal.style.display = 'none'; };

    $('#search-reader').on('input', function () {
        const query = $(this).val();
        $.get("{% url 'ajax_issue_search' %}", { q: query }, function (data) {
            $('#issue-body').html(data.html);
        });
    });

    function toggleDropdown(id) {
        const dropdown = document.getElementById(id);
        dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
    }

    function selectValue(fieldId, value) {
        document.getElementById(fieldId).value = value;
        document.querySelectorAll('.dropdown-list').forEach(el => el.style.display = 'none');
    }
    function selectReader(fullName, telegramUsername) {
        document.getElementById("nameField").value = fullName;
        document.getElementById("telegramField").value = telegramUsername;
        document.querySelectorAll('.dropdown-list').forEach(el => el.style.display = 'none');
    }

    document.addEventListener("DOMContentLoaded", function () {
        function setupLiveFilter(inputId, dropdownId) {
            const input = document.getElementById(inputId);
            const dropdown = document.getElementById(dropdownId);
            const options = dropdown.querySelectorAll('div');

            input.addEventListener('input', function () {
                const filter = input.value.toLowerCase();
                options.forEach(option => {
                    option.style.display = option.textContent.toLowerCase().includes(filter) ? '' : 'none';
                });
                dropdown.style.display = 'block';
            });
        }

        setupLiveFilter('telegramField', 'telegramDropdown');
        setupLiveFilter('bookField', 'bookDropdown');
        setupLiveFilter('nameField', 'nameDropdown'); // üëà –¥–æ–±–∞–≤–∏–ª–∏ –∏–º—è
    });

    $('#toggle-overdue').on('click', function (e) {
    e.preventDefault();

    const $overdue = $('#overdue-section');
    const $issue = $('#issue-section');
    const $controls = $('#main-controls');
    const $title = $('#table-title');

    if ($overdue.is(':visible')) {
        $overdue.hide();
        $issue.show();
        $controls.show();
        $(this).text('–¢–∞–±–ª–∏—Ü–∞ –¥–æ–ª–∂–Ω–∏–∫–æ–≤');
        $title.text('–¢–∞–±–ª–∏—Ü–∞ –≤—ã–¥–∞–Ω–Ω—ã—Ö –∫–Ω–∏–≥');
    } else {
        $.get("{% url 'overdue_issues_partial' %}", function (data) {
            $overdue.html(data.html).show();
            $issue.hide();
            $controls.hide();
            $('#toggle-overdue').text('‚¨Ö –ù–ê–ó–ê–î');
            $title.text('–¢–∞–±–ª–∏—Ü–∞ –¥–æ–ª–∂–Ω–∏–∫–æ–≤');
        });
    }
    });
    
    // üîç –ü–æ–∏—Å–∫ —Å—Ä–µ–¥–∏ –¥–æ–ª–∂–Ω–∏–∫–æ–≤ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
    $(document).on('input', '#search-overdue', function () {
        const query = $(this).val();
        $.get("{% url 'ajax_overdue_search' %}", { q: query }, function (data) {
            $('#overdue-section').html(data.html);
        });
    });
    const readerMap = [];
    document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll("#nameDropdown div").forEach(item => {
            readerMap.push({
                fullName: item.dataset.fullname,
                telegram: item.dataset.telegram || ""
            });
        });
    });

    function selectReader(fullName, telegramUsername) {
        document.getElementById("nameField").value = fullName;
        document.getElementById("telegramField").value = telegramUsername;
        document.querySelectorAll('.dropdown-list').forEach(el => el.style.display = 'none');
    }

    // ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è: –∏–º—è –∏ –ª–æ–≥–∏–Ω –¥–æ–ª–∂–Ω—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å
    document.querySelector("#issueModal form").addEventListener("submit", function (e) {
    const fullName = document.getElementById("nameField").value.trim();
    const telegramInput = document.getElementById("telegramField").value.trim();

    const matches = readerMap.filter(r => r.fullName === fullName);

    if (matches.length === 1) {
        const expectedTelegram = matches[0].telegram;
        if (expectedTelegram && telegramInput !== expectedTelegram) {
            e.preventDefault();
            alert(`‚ùå Telegram –ª–æ–≥–∏–Ω "${telegramInput}" –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∏–º–µ–Ω–∏ "${fullName}". –û–∂–∏–¥–∞–ª—Å—è: ${expectedTelegram}`);
        }
    } else if (matches.length > 1) {
        // –ù–µ—Å–∫–æ–ª—å–∫–æ –æ–¥–Ω–æ—Ñ–∞–º–∏–ª—å—Ü–µ–≤ ‚Äî –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ Telegram
        const exact = matches.find(r => r.telegram === telegramInput);
        if (!exact) {
            e.preventDefault();
            const possible = matches.map(r => r.telegram || "‚Äî").join(", ");
            alert(`‚ùå –ò–º—è "${fullName}" –Ω–µ —É–Ω–∏–∫–∞–ª—å–Ω–æ. –£–∫–∞–∂–∏—Ç–µ Telegram –ª–æ–≥–∏–Ω. –í–æ–∑–º–æ–∂–Ω—ã–µ: ${possible}`);
        }
    }
    });




</script>

</body>
</html>
