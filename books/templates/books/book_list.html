{% load static %} 
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ XX</title>
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
</head>
<body>

<!-- üîù –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ö–µ–¥–µ—Ä -->
<header class="header-bar">
    <div class="header-nav">
        <a href="{% url 'book_list' %}" class="header-title">–£–ü–†–ê–í–õ–ï–ù–ò–ï –ö–ù–ò–ñ–ù–´–ú –§–û–ù–î–û–ú</a>
        <a href="{% url 'book_issue' %}" class="header-link">–í–´–î–ê–ß–ê –ö–ù–ò–ì</a>
        <a href="{% url 'readers_list' %}" class="header-link">–ß–ò–¢–ê–¢–ï–õ–ò</a>
        <a href="#" class="header-link">–°–¢–ê–¢–ò–°–¢–ò–ö–ê</a>
        <a href="{% url 'staff_login' %}" class="header-link">–í–´–•–û–î</a>
    </div>
    <div class="header-right">
        <button id="openModal" class="add-button">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∫–Ω–∏–≥—É</button>
    </div>
</header>

<!-- üìö –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
<main class="content">
    <div class="filters">
        <form method="get" id="search-form">
            <label for="type">–ü–æ–∏—Å–∫ –∫–Ω–∏–≥–∏ –ø–æ:</label>
            <select name="type" id="search-type">
                <option value="title" {% if search_type == 'title' %}selected{% endif %}>–Ω–∞–∑–≤–∞–Ω–∏—é</option>
                <option value="author" {% if search_type == 'author' %}selected{% endif %}>–∞–≤—Ç–æ—Ä—É</option>
                <option value="year" {% if search_type == 'year' %}selected{% endif %}>–≥–æ–¥—É</option>
            </select>
            <input type="text" name="q" id="search-box" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ..." value="{{ query }}">
        </form>
    </div>

    <div class="book-container">
        {% for book in books %}
        <div class="book-card">
            <a href="{% url 'delete_book' book.pk %}" class="delete-icon" title="–£–¥–∞–ª–∏—Ç—å">‚ùå</a>
            {% if book.cover_image %}
                <img src="{{ book.cover_image.url }}" alt="{{ book.title }}">
            {% else %}
                <img src="{% static 'images/default_cover.jpg' %}" alt="–û–±–ª–æ–∂–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç">
            {% endif %}
            <p><strong>{{ book.title }}</strong></p>
            <p>–ê–≤—Ç–æ—Ä: {{ book.author }}</p>
            <p>–ò–∑–¥–∞—Ç–µ–ª—å—Å—Ç–≤–æ: {{ book.publisher|default_if_none:"–ù–µ —É–∫–∞–∑–∞–Ω–æ" }}</p>
            <p>–ì–æ–¥: {{ book.year|default_if_none:"–ù–µ —É–∫–∞–∑–∞–Ω–æ" }}</p>
            <p>–†–∞–∑–º–µ—â–µ–Ω–∏–µ: {{ book.location|default_if_none:"–ù–µ —É–∫–∞–∑–∞–Ω–æ" }}</p>
            <p>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: {{ book.quantity }}</p>
        </div>
        {% endfor %}
    </div>
</main>

<!-- üì¶ –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
<div id="modal" class="modal">
    <div class="modal-content">
        <span id="closeModal" class="close">&times;</span>
        <h2>–î–æ–±–∞–≤–∏—Ç—å –∫–Ω–∏–≥—É</h2>
        <form id="add-book-form" enctype="multipart/form-data">
            {% csrf_token %}
            <p><input type="text" name="title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–Ω–∏–≥–∏" required></p>
            <p><input type="text" name="author" placeholder="–ê–≤—Ç–æ—Ä" required></p>
            <p><input type="text" name="publisher" placeholder="–ò–∑–¥–∞—Ç–µ–ª—å—Å—Ç–≤–æ"></p>
            <p><input type="number" name="year" placeholder="–ì–æ–¥ –Ω–∞–ø–∏—Å–∞–Ω–∏—è"></p>
            <p><input type="text" name="location" placeholder="–†–∞–∑–º–µ—â–µ–Ω–∏–µ"></p>
            <p><input type="file" name="cover_image"></p>
            <p><input type="number" name="quantity" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ" min="1"></p>
            <input type="hidden" name="cover_auto">
            <div id="cover-preview" style="margin: 10px 0;"></div>
            <div id="form-errors" style="color: red; font-size: 14px;"></div>
            <button type="submit" class="add-button">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </form>
    </div>
</div>

<footer class="site-footer">
    <div class="footer-content">
        <p>Made by Andrey Kovalev, Vladivostok, Russia</p>
        <a href="https://t.me/zxcikona20" target="_blank" title="Telegram">
            <img src="{% static 'images/telegram_icon.png' %}" alt="Telegram" class="telegram-icon">
        </a>
    </div>
</footer>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(function () {
    function updateBooks() {
        const searchType = $('#search-type').val();
        const searchTerm = $('#search-box').val();
        $.get("{% url 'ajax_book_list' %}", {
            type: searchType,
            q: searchTerm
        }, function (data) {
            $('.book-container').html(data.html);
        });
    }

    $('#search-box').on('input', updateBooks);
    $('#search-type').on('change', function () {
        $('#search-box').val('');
        updateBooks();
    });

    $('#search-form').on('submit', function (e) {
        e.preventDefault();
        updateBooks();
    });

    $('#openModal').on('click', () => $('#modal').css('display', 'flex'));
    $('#closeModal').on('click', () => $('#modal').hide());
    window.onclick = (e) => { if (e.target === document.getElementById('modal')) $('#modal').hide(); };

    $('input[name="title"]').on('blur', function () {
        const title = $(this).val().trim();
        if (!title) return;

        $.get('/books/fetch-cover/', { title: title }, function (data) {
            if (data.image_urls) {
                let previewHTML = '<div class="cover-scroll">';
                data.image_urls.forEach(url => {
                    previewHTML += `<img src="${url}" class="cover-option">`;
                });
                previewHTML += '</div>';
                $('#cover-preview').html(previewHTML);

                $('.cover-option').on('click', function () {
                    $('.cover-option').removeClass('selected');
                    $(this).addClass('selected');
                    $('input[name="cover_auto"]').val($(this).attr('src'));
                });
            }

            if (data.author) {
                $('input[name="author"]').val(data.author);
            }
           
        });
    });

    $('#add-book-form').on('submit', function (e) {
        e.preventDefault();
        const formData = new FormData(this);
        $.ajax({
            url: "{% url 'add_book' %}",
            type: "POST",
            data: formData,
            contentType: false,
            processData: false,
            success: function (data) {
                if (data.success) {
                    $('#modal').hide();
                    $('#add-book-form')[0].reset();
                    $('#cover-preview').empty();
                    $('#form-errors').empty();
                    updateBooks();
                }
            },
            error: function (xhr) {
                const errors = xhr.responseJSON?.errors;
                if (errors) {
                    let html = '';
                    for (const field in errors) {
                        html += `<p>${errors[field].join(', ')}</p>`;
                    }
                    $('#form-errors').html(html);
                } else {
                    alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∫–Ω–∏–≥–∏.");
                }
            }
        });
    });
});
</script>
</body>
</html>
